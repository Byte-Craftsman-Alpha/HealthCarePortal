{% extends 'base.html' %}
{% block content %}
  <div class="flex items-start justify-between gap-4 flex-wrap">
    <div>
      <h1 class="text-xl font-semibold" style="color: var(--text-primary);">Dashboard</h1>
      <p class="text-sm mt-1" style="color: var(--text-muted);">Your data stays yours. You decide who can access it.</p>
    </div>
    <div class="flex items-center gap-2">
      <a class="portal-btn-soft" href="{{ url_for('patient.records') }}">
        <span class="iconify" data-icon="solar:document-text-linear"></span>
        View records
      </a>
      <a class="minimal-btn minimal-btn-primary" href="{{ url_for('patient.appointments') }}">
        <span class="iconify" data-icon="solar:calendar-mark-linear"></span>
        Book appointment
      </a>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mt-6">
    <div class="lg:col-span-8 space-y-6">
      <div class="minimal-card p-6">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <div class="text-sm" style="color: var(--text-muted);">Good morning,</div>
            <div class="text-xl font-semibold" style="color: var(--text-primary);">{{ current_user.name or 'Patient' }}</div>
            <div class="text-xs mt-2" style="color: var(--text-muted);">Welcome back. Here's your snapshot for today.</div>
          </div>
          <div class="flex items-center gap-2">
            <a class="portal-btn-soft" href="{{ url_for('patient.records') }}">
              <span class="iconify" data-icon="solar:folder-open-linear"></span>
              View records
            </a>
            <a class="minimal-btn minimal-btn-primary" href="{{ url_for('patient.appointments') }}">
              <span class="iconify" data-icon="solar:calendar-add-linear"></span>
              Book appointment
            </a>
          </div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-5">
          <div class="rounded-2xl p-4" style="background: var(--surface-secondary); border: 1px solid var(--border-secondary);">
            <div class="text-xs" style="color: var(--text-muted);">Consents</div>
            <div class="mt-2 text-sm font-semibold" style="color: var(--text-primary);">{{ active_consents }}</div>
          </div>
          <div class="rounded-2xl p-4" style="background: var(--surface-secondary); border: 1px solid var(--border-secondary);">
            <div class="text-xs" style="color: var(--text-muted);">Records</div>
            <div class="mt-2 text-sm font-semibold" style="color: var(--text-primary);">{{ recent_records|length }}</div>
          </div>
          <div class="rounded-2xl p-4" style="background: var(--surface-secondary); border: 1px solid var(--border-secondary);">
            <div class="text-xs" style="color: var(--text-muted);">Appointments</div>
            <div class="mt-2 text-sm font-semibold" style="color: var(--text-primary);">{{ recent_appointments|length }}</div>
          </div>
          <div class="rounded-2xl p-4" style="background: var(--surface-secondary); border: 1px solid var(--border-secondary);">
            <div class="text-xs" style="color: var(--text-muted);">Emergency</div>
            <div class="mt-2 text-sm font-semibold" style="color: var(--text-primary);">{{ 'Set' if (patient.blood_group or patient.allergies or patient.chronic_conditions or patient.emergency_contacts) else 'Not set' }}</div>
          </div>
        </div>
      </div>

      <div class="minimal-card p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Recent activity</h2>
          <span class="text-xs" style="color: var(--text-muted);">Last 5</span>
        </div>
        <div class="mt-4 space-y-3">
          {% if recent_appointments|length == 0 and recent_records|length == 0 %}
            <div class="text-sm" style="color: var(--text-muted);">No activity yet.</div>
          {% endif %}

          {% for a in recent_appointments %}
            <div class="flex items-start justify-between gap-4 rounded-xl p-4" style="border: 1px solid var(--border-secondary);">
              <div>
                <div class="text-sm font-medium" style="color: var(--text-primary);">Appointment</div>
                <div class="text-xs mt-1" style="color: var(--text-muted);">{{ a.scheduled_at.strftime('%Y-%m-%d %H:%M') }} · Status: {{ a.status }}</div>
              </div>
              <span class="text-xs" style="color: var(--text-muted);">Doctor #{{ a.doctor_id }}</span>
            </div>
          {% endfor %}

          {% for r in recent_records %}
            <div class="flex items-start justify-between gap-4 rounded-xl p-4" style="border: 1px solid var(--border-secondary);">
              <div>
                <div class="text-sm font-medium" style="color: var(--text-primary);">Record uploaded</div>
                <div class="text-xs mt-1" style="color: var(--text-muted);">{{ r.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</div>
                {% if r.description %}
                  <div class="text-sm mt-2" style="color: var(--text-secondary);">{{ r.description }}</div>
                {% endif %}
              </div>
              <a class="text-sm font-medium" style="color: var(--accent);" href="{{ url_for('static', filename=r.file_path) }}" target="_blank" rel="noopener">Open</a>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="lg:col-span-4 space-y-6">
      <div class="minimal-card p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">Next appointment</div>
            {% if recent_appointments|length > 0 %}
              <div class="text-sm font-semibold mt-2" style="color: var(--text-primary);">{{ recent_appointments[0].scheduled_at.strftime('%Y-%m-%d %H:%M') }}</div>
              <div class="text-xs mt-1" style="color: var(--text-muted);">Doctor #{{ recent_appointments[0].doctor_id }} · Status: {{ recent_appointments[0].status }}</div>
            {% else %}
              <div class="text-sm mt-2" style="color: var(--text-muted);">No upcoming appointments.</div>
            {% endif %}
          </div>
        </div>
        <div class="mt-4 flex items-center gap-2">
          <a class="minimal-btn minimal-btn-primary flex-1 justify-center" href="{{ url_for('patient.appointments') }}">
            <span class="iconify" data-icon="solar:calendar-add-linear"></span>
            Book
          </a>
          <a class="portal-btn-soft flex-1 justify-center" href="{{ url_for('patient.appointments') }}">
            <span class="iconify" data-icon="solar:refresh-linear"></span>
            Reschedule
          </a>
        </div>
      </div>

      <div class="minimal-card p-5">
        <div class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">Emergency</div>
        <div class="text-sm mt-2" style="color: var(--text-muted);">Quick access to your emergency profile.</div>
        <div class="mt-4">
          <a class="portal-btn-soft w-full justify-center" href="{{ url_for('patient.emergency_profile') }}">
            <span class="iconify" data-icon="solar:pen-new-square-linear"></span>
            Update emergency profile
          </a>
        </div>
      </div>

      <div class="minimal-card p-5">
        <h2 class="text-base font-semibold" style="color: var(--text-primary);">Emergency summary</h2>
        <p class="text-sm mt-1" style="color: var(--text-muted);">Visible to Emergency role only (read-only subset).</p>

        <div class="grid grid-cols-1 gap-3 mt-4">
          <div class="rounded-xl p-4" style="border: 1px solid var(--border-secondary);">
            <div class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">Blood group</div>
            <div class="text-sm font-medium mt-2" style="color: var(--text-primary);">{{ patient.blood_group or 'Not set' }}</div>
          </div>
          <div class="rounded-xl p-4" style="border: 1px solid var(--border-secondary);">
            <div class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">Allergies</div>
            <div class="text-sm font-medium mt-2" style="color: var(--text-primary);">{{ patient.allergies or 'Not set' }}</div>
          </div>
          <div class="rounded-xl p-4" style="border: 1px solid var(--border-secondary);">
            <div class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">Chronic conditions</div>
            <div class="text-sm font-medium mt-2" style="color: var(--text-primary);">{{ patient.chronic_conditions or 'Not set' }}</div>
          </div>
          <div class="rounded-xl p-4" style="border: 1px solid var(--border-secondary);">
            <div class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">Emergency contacts</div>
            <div class="text-sm font-medium mt-2" style="color: var(--text-primary);">{{ patient.emergency_contacts or 'Not set' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
