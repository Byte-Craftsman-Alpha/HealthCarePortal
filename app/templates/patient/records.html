{% extends 'base.html' %}
{% from 'components/ui.html' import card, label, input, select, btn %}
{% block content %}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {% call card(cls='p-6 lg:col-span-1') %}
      <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Upload</h2>
      <form method="post" enctype="multipart/form-data" class="space-y-4 mt-4">
        <div>
          {{ label('file', 'File') }}
          <input class="minimal-input" id="file" name="file" type="file" required />
        </div>
        <div>
          {{ label('description', 'Description') }}
          {{ input('description', 'description', placeholder='e.g., MRI report, blood test') }}
        </div>
        <div>
          {{ label('appointment_id', 'Link to appointment (optional)') }}
          {% set appt_options = [('', 'Not linked')] %}
          {% for a in appointments %}
            {% set _ = appt_options.append((a.id, '#' ~ a.id ~ ' · ' ~ a.scheduled_at.strftime('%Y-%m-%d') ~ ' · Doctor #' ~ a.doctor_id)) %}
          {% endfor %}
          {{ select('appointment_id', 'appointment_id', appt_options) }}
        </div>
        {{ btn('Upload', icon_name='solar:upload-linear', variant='primary', type='submit', cls='w-full') }}
      </form>
    {% endcall %}

    {% call card(cls='p-6 lg:col-span-2') %}
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Your records</h2>
        <span class="text-xs" style="color: var(--text-muted);">{{ records|length }} total</span>
      </div>

      <div class="mt-4 space-y-3">
        {% if records|length == 0 %}
          <div class="text-sm" style="color: var(--text-muted);">No records uploaded yet.</div>
        {% endif %}

        {% for r in records %}
          <div class="rounded-2xl p-4 flex items-start justify-between gap-4" style="border: 1px solid var(--border-secondary);">
            <div>
              <div class="text-sm font-medium" style="color: var(--text-primary);">{{ r.description or 'Medical record' }}</div>
              <div class="text-xs mt-1" style="color: var(--text-muted);">Uploaded {{ r.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</div>
              {% if r.appointment_id %}
                <div class="text-xs mt-1" style="color: var(--text-muted);">Linked appointment: #{{ r.appointment_id }}</div>
              {% endif %}
            </div>
            {{ btn('View', icon_name='solar:eye-linear', href=url_for('patient.record_view', record_id=r.id), variant='soft', cls='', title='View') }}
          </div>
        {% endfor %}
      </div>
    {% endcall %}
  </div>
{% endblock %}
