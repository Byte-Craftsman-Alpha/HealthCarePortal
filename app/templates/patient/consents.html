{% extends 'base.html' %}
{% block content %}
  <h1 class="text-xl font-semibold" style="color: var(--text-primary);">Doctor Consents</h1>
  <p class="text-sm mt-1" style="color: var(--text-muted);">Grant or revoke access. Control whether a doctor can view history and/or add records.</p>

  <div class="minimal-card p-6 mt-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% for d in doctors %}
        {% set c = consent_by_doctor.get(d.user_id) %}
        <div class="rounded-2xl p-5" style="border: 1px solid var(--border-secondary);">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-sm font-semibold" style="color: var(--text-primary);">Doctor #{{ d.user_id }}</div>
              <div class="text-sm mt-1" style="color: var(--text-muted);">{{ d.specialization }}</div>
              <div class="text-xs mt-2" style="color: var(--text-muted);">Hospital: {{ d.hospital_id or 'N/A' }}</div>
              {% if c and c.revoked_at is none %}
                <div class="text-xs mt-2" style="color: var(--text-muted);">Scopes: {% if c.can_view_history %}View history{% else %}No history{% endif %} Â· {% if c.can_add_record %}Add records{% else %}No uploads{% endif %}</div>
              {% endif %}
            </div>
            <div class="text-right">
              {% if c and c.revoked_at is none %}
                <div class="text-xs uppercase tracking-wider text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-full px-3 py-1 inline-block">Active</div>
              {% elif c and c.revoked_at is not none %}
                <div class="text-xs uppercase tracking-wider text-rose-700 bg-rose-50 border border-rose-200 rounded-full px-3 py-1 inline-block">Revoked</div>
              {% else %}
                <div class="text-xs uppercase tracking-wider text-slate-500 bg-slate-50 border border-slate-200 rounded-full px-3 py-1 inline-block">Not granted</div>
              {% endif %}
            </div>
          </div>

          <div class="mt-4 flex gap-3 flex-wrap">
            <form method="post" class="w-full">
              <input type="hidden" name="doctor_id" value="{{ d.user_id }}" />
              <input type="hidden" name="action" value="grant" />

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <label class="flex items-center gap-2 text-sm" style="color: var(--text-secondary);">
                  <input type="checkbox" name="can_view_history" {% if not c or (c and c.can_view_history) %}checked{% endif %} />
                  View medical history
                </label>
                <label class="flex items-center gap-2 text-sm" style="color: var(--text-secondary);">
                  <input type="checkbox" name="can_add_record" {% if c and c.can_add_record %}checked{% endif %} />
                  Allow doctor to add records
                </label>
              </div>

              <div class="mt-3">
                <button class="minimal-btn minimal-btn-primary" type="submit">
                  <span class="iconify" data-icon="solar:shield-check-linear"></span>
                  Save permission
                </button>
              </div>
            </form>

            <form method="post">
              <input type="hidden" name="doctor_id" value="{{ d.user_id }}" />
              <input type="hidden" name="action" value="revoke" />
              <button class="portal-btn-soft" type="submit">
                <span class="iconify" data-icon="solar:shield-cross-linear"></span>
                Revoke
              </button>
            </form>
          </div>

          {% if c and c.granted_at %}
            <div class="text-xs mt-3" style="color: var(--text-muted);">Granted: {{ c.granted_at.strftime('%Y-%m-%d %H:%M') }}</div>
          {% endif %}
          {% if c and c.revoked_at %}
            <div class="text-xs mt-1" style="color: var(--text-muted);">Revoked: {{ c.revoked_at.strftime('%Y-%m-%d %H:%M') }}</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
{% endblock %}
