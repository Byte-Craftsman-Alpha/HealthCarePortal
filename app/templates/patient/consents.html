{% extends 'base.html' %}
{% from 'components/ui.html' import card, btn, badge %}
{% block content %}
  {% call card(cls='p-6') %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% for org in organizations %}
        {% set c = consent_by_org.get(org.id) %}
        <div class="rounded-2xl p-5" style="border: 1px solid var(--border-secondary);">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-sm font-semibold" style="color: var(--text-primary);">{{ org.name }}</div>
              <div class="text-xs mt-2" style="color: var(--text-muted);">Type: {{ org.org_type }}</div>
              {% if c and c.revoked_at is none %}
                <div class="text-xs mt-2" style="color: var(--text-muted);">Scopes: {% if c.can_view_history %}View history{% else %}No history{% endif %} Â· {% if c.can_add_record %}Add records{% else %}No uploads{% endif %}</div>
              {% endif %}
            </div>
            <div class="text-right">
              {% if c and c.revoked_at is none %}
                {{ badge('Active', 'success') }}
              {% elif c and c.revoked_at is not none %}
                {{ badge('Revoked', 'danger') }}
              {% else %}
                {{ badge('Not granted', 'neutral') }}
              {% endif %}
            </div>
          </div>

          <div class="mt-4 flex gap-3 flex-wrap">
            <form method="post" class="w-full">
              <input type="hidden" name="organization_id" value="{{ org.id }}" />
              <input type="hidden" name="action" value="grant" />

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <label class="flex items-center gap-2 text-sm" style="color: var(--text-secondary);">
                  <input type="checkbox" name="can_view_history" {% if not c or (c and c.can_view_history) %}checked{% endif %} />
                  View medical history
                </label>
                <label class="flex items-center gap-2 text-sm" style="color: var(--text-secondary);">
                  <input type="checkbox" name="can_add_record" {% if c and c.can_add_record %}checked{% endif %} />
                  Allow doctor to add records
                </label>
              </div>

              <div class="mt-3">
                {{ btn('Save permission', icon_name='solar:shield-check-linear', variant='primary', type='submit') }}
              </div>
            </form>

            <form method="post">
              <input type="hidden" name="organization_id" value="{{ org.id }}" />
              <input type="hidden" name="action" value="revoke" />
              {{ btn('Revoke', icon_name='solar:shield-cross-linear', variant='soft', type='submit') }}
            </form>
          </div>

          {% if c and c.granted_at %}
            <div class="text-xs mt-3" style="color: var(--text-muted);">Granted: {{ c.granted_at.strftime('%Y-%m-%d %H:%M') }}</div>
          {% endif %}
          {% if c and c.revoked_at %}
            <div class="text-xs mt-1" style="color: var(--text-muted);">Revoked: {{ c.revoked_at.strftime('%Y-%m-%d %H:%M') }}</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% endcall %}
{% endblock %}
